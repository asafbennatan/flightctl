# localhost:5000/flightctl-device:base
#     ${IP}:5000/flightctl-device:base
#
# Base bootc image used for E2E testing and agent-vm with the following features:
#
# * User/pw: user/user
# * Trust on our E2E CA Certificate
# * flightctl-agent configured to talk to our e2e kind flightctl-server
# * greenboot and podman-compose installed with podman service enabled
# * Built on top of the golden base image

FROM localhost:5000/flightctl-device:golden

ARG RPM_COPR=
ARG RPM_PACKAGE=flightctl-agent
ARG REGISTRY_ADDRESS
ARG BREW_BUILD_URL=

# Fail early when the build argument is missing
RUN test -n "${REGISTRY_ADDRESS}" || (echo "REGISTRY_ADDRESS build arg is required" >&2 && exit 1)

# Copy only the RPM directories needed for installation
# Note: These directories must exist (can be empty) - created by prepare_agent_config.sh
COPY bin/rpm/ /tmp/bin/rpm/
COPY bin/brew-rpm/ /tmp/bin/brew-rpm/

# E2E tmpfiles configuration for offline-injected files
COPY test/scripts/agent-images/flightctl-e2e.tmpfiles.conf /usr/lib/tmpfiles.d/flightctl-e2e.tmpfiles.conf

RUN if [[ -n "$BREW_BUILD_URL" ]]; then \
        echo "Installing RPMs from brew URL: ${BREW_BUILD_URL}"; \
        dnf install -y /tmp/bin/brew-rpm/flightctl-agent-*.rpm /tmp/bin/brew-rpm/flightctl-selinux-*.rpm /tmp/bin/brew-rpm/flightctl-debuginfo-*.rpm; \
    elif [[ -n "$RPM_COPR" ]]; then \
        echo "Installing RPMs from COPR repository: ${RPM_COPR}" && \
        dnf copr -y enable ${RPM_COPR} && \
        dnf install -y ${RPM_PACKAGE}; \
    else \
        echo "Installing local RPMs" && \
        dnf install -y /tmp/bin/rpm/flightctl-agent-*.rpm /tmp/bin/rpm/flightctl-selinux-*.rpm; \
    fi && \
    systemctl enable flightctl-agent.service && \
    echo "Cleaning up build files from /tmp/bin" && \
    rm -rf /tmp/bin

# Add the registry
RUN mkdir -p /etc/containers/registries.conf.d/ && \
    echo "[[registry]]" > /etc/containers/registries.conf.d/custom-registry.conf && \
    echo "location = \"${REGISTRY_ADDRESS}\"" >> /etc/containers/registries.conf.d/custom-registry.conf && \
    echo "insecure = true" >> /etc/containers/registries.conf.d/custom-registry.conf
