# Generic base bootc image for E2E testing and agent-vm
# This is a cached template that contains only static data
# Run-specific data (config, certificates, RPMs) will be injected via cloud-init
#
# Features:
# * User/pw: user/user
# * Base packages: epel-release, python-dotenv, greenboot, podman-compose, firewalld
# * Custom info scripts directory structure
# * No run-specific configuration or certificates

FROM quay.io/centos-bootc/centos-bootc:stream9

# Install base packages that don't change between runs
RUN --mount=type=cache,target=/var/cache/dnf \
    --mount=type=cache,target=/var/lib/dnf \
    dnf install -y epel-release epel-next-release

RUN --mount=type=cache,target=/var/cache/dnf \
    --mount=type=cache,target=/var/lib/dnf \
    dnf install -y python-dotenv

RUN --mount=type=cache,target=/var/cache/dnf \
    --mount=type=cache,target=/var/lib/dnf \
    dnf install -y greenboot greenboot-default-health-checks podman-compose && \
    dnf install -y firewalld && \
    systemctl enable firewalld.service && \
    systemctl enable podman.service

# Create user with sudo access
RUN useradd -ms /bin/bash user && \
    echo "user:user" | chpasswd && \
    echo "user ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

# Create flightctl custom info directory structure
RUN mkdir -p /usr/lib/flightctl/custom-info.d && \
    chmod 755 /usr/lib/flightctl/custom-info.d

# Add static custom system info scripts
RUN echo '#!/bin/bash\necho "my site"' > /usr/lib/flightctl/custom-info.d/siteName && \
    echo '#!/bin/bash\necho ""' > /usr/lib/flightctl/custom-info.d/test && \
    echo '#!/bin/bash\necho "no-show"' > /usr/lib/flightctl/custom-info.d/keyNotShown && \
    chmod 755 /usr/lib/flightctl/custom-info.d/*

# Create directories for run-specific data (will be populated via cloud-init)
RUN mkdir -p /etc/flightctl/certs && \
    mkdir -p /etc/flightctl && \
    mkdir -p /etc/containers/registries.conf.d && \
    mkdir -p /etc/pki/ca-trust/source/anchors

# Create a placeholder cloud-init script that will be replaced at runtime
RUN echo '#!/bin/bash' > /usr/local/bin/setup-flightctl.sh && \
    echo '# This script will be replaced with run-specific configuration' >> /usr/local/bin/setup-flightctl.sh && \
    echo 'echo "Generic template - no configuration applied"' >> /usr/local/bin/setup-flightctl.sh && \
    chmod +x /usr/local/bin/setup-flightctl.sh

# Add build metadata for caching
ARG SOURCE_GIT_TAG=latest
ARG SOURCE_GIT_TREE_STATE=clean
ARG SOURCE_GIT_COMMIT=unknown

LABEL org.flightctl.flightctl-e2e-base-generic.source.git.tag="${SOURCE_GIT_TAG}" \
      org.flightctl.flightctl-e2e-base-generic.source.git.tree-state="${SOURCE_GIT_TREE_STATE}" \
      org.flightctl.flightctl-e2e-base-generic.source.git.commit="${SOURCE_GIT_COMMIT}" \
      org.flightctl.flightctl-e2e-base-generic.template="generic" \
      org.flightctl.flightctl-e2e-base-generic.description="Generic E2E base template for caching"
